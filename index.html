<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Live Transcribe (Demo)</title>
<style>
  /* Simple mobile-first layout */
  body { font-family: system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; margin: 0; padding: 0.75rem; background:#f7fafc; color:#111827; }
  header { display:flex; gap:0.5rem; align-items:center; justify-content:space-between; }
  button { padding: .6rem 1rem; border-radius: 8px; border: none; background:#111827; color:#fff; font-weight:600; }
  .row { display:flex; gap:.5rem; margin-top: .75rem; }
  .panel { flex:1; background:#fff; border-radius:12px; padding:.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height:120px; overflow:auto; }
  .panel h3 { margin:0 0 .5rem 0; font-size:0.95rem; }
  .status { font-size:0.85rem; color:#6b7280; margin-top:.5rem; }
  .small { font-size:0.85rem; color:#6b7280; }
  @media(min-width:800px){ .row { flex-direction:row; } }
  @media(max-width:799px){ .row { flex-direction:column; } }
</style>
</head>
<body>
  <header>
    <h2>Live Transcription and Translation</h2>
    <div>
      <label class="small">Input language:
        <select id="langSelect"><option value="">auto</option><option value="en">English</option><option value="ur">Urdu</option></select>
      </label>
    </div>
  </header>

  <div style="margin-top:.75rem">
    <button id="toggleBtn">Start</button>
    <span class="status" id="status">Idle</span>
  </div>

  <div class="row">
    <div class="panel">
      <h3>Original transcript (live)</h3>
      <div id="original"></div>
    </div>

    <div class="panel">
      <h3>Translated transcript (future: second half)</h3>
      <div id="translated" style="opacity:.5">Translation will appear here in the second half.</div>
    </div>
  </div>

<script>
const toggleBtn = document.getElementById("toggleBtn");
const statusEl = document.getElementById("status");
const originalEl = document.getElementById("original");
const langSelect = document.getElementById("langSelect");

let audioStream = null;
let mediaRecorder = null;
let chunkIndex = 0;
let running = false;

async function startRecording(){
  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (err) {
    alert("Microphone permission required: " + err.message);
    return;
  }

  chunkIndex = 0;
  running = true;
  recordNextChunk(); // start the first chunk
}

function recordNextChunk(){
  if (!running) return;

  mediaRecorder = new MediaRecorder(audioStream, { mimeType: 'audio/webm;codecs=opus' });
  
  mediaRecorder.addEventListener('dataavailable', async (ev) => {
    if (!ev.data || ev.data.size < 200) return;

    const blob = new Blob([ev.data], {type: 'audio/webm;codecs=opus'});
    const file = new File([blob], `chunk-${chunkIndex++}.webm`, { type: 'audio/webm;codecs=opus' });

    const form = new FormData();
    form.append('audio', file);
    const language = langSelect.value;
    if (language) form.append('language', language);

    // send to API
    statusEl.textContent = 'Sending chunk...';
    try {
      const res = await fetch('http://127.0.0.1:8000/transcribe-chunk', {
        method: 'POST',
        body: form
      });
      if (!res.ok) {
        statusEl.textContent = 'Server error';
        return;
      }
      const j = await res.json();
      const p = document.createElement('p');
      p.textContent = j.text;
      originalEl.appendChild(p);
      originalEl.scrollTop = originalEl.scrollHeight;
      statusEl.textContent = `Listening â€” last model: ${j.model}`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Network error';
    }
  });

  mediaRecorder.addEventListener('stop', () => {
    // after this chunk, record the next one
    if (running) {
      recordNextChunk();
    }
  });

  mediaRecorder.start();
  setTimeout(() => {
    mediaRecorder.stop(); // finalize this chunk
  }, 3000); // 3 seconds per chunk
}


function stopRecording() {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
  }
  if (audioStream) {
    audioStream.getTracks().forEach((t) => t.stop());
  }
  mediaRecorder = null;
  audioStream = null;
  statusEl.textContent = "Stopped";
  running = false;
}

toggleBtn.addEventListener("click", () => {
  if (!running) {
    startRecording();
    toggleBtn.textContent = "Stop";
  } else {
    stopRecording();
    toggleBtn.textContent = "Start";
  }
});
</script>
</body>
</html>
