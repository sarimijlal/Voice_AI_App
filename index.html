<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Live Transcription and Translation</title>
    <style>
      /* Simple mobile-first layout */
      body {
        font-family: system-ui, -apple-system, Roboto, "Helvetica Neue", Arial;
        margin: 0;
        padding: 0.75rem;
        background: #f7fafc;
        color: #111827;
      }
      header {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
      }
      button {
        padding: 0.6rem 1rem;
        border-radius: 8px;
        border: none;
        background: #111827;
        color: #fff;
        font-weight: 600;
      }
      .row {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
      }
      .panel {
        flex: 1;
        background: #fff;
        border-radius: 12px;
        padding: 0.75rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        min-height: 120px;
        overflow: auto;
      }
      .panel h3 {
        margin: 0 0 0.5rem 0;
        font-size: 0.95rem;
      }
      .status {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.5rem;
      }
      .small {
        font-size: 0.85rem;
        color: #6b7280;
      }
      @media (min-width: 800px) {
        .row {
          flex-direction: row;
        }
      }
      @media (max-width: 799px) {
        .row {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h2>Live Transcription and Translation</h2>
      <div>
        <label class="small"
          >Speaker language:
          <select id="speakerLangSelect">
            <option value="">Auto detect</option>
            <option value="en">English</option>
            <option value="ur">Urdu</option>
          </select>
        </label>

        <label class="small"
          >Listener language:
          <select id="listenerLangSelect">
            <option value="en">English</option>
            <option value="ur">Urdu</option>
            <option value="fr">French</option>
            <!-- Add more as needed -->
          </select>
        </label>
      </div>
    </header>

    <div style="margin-top: 0.75rem">
      <button id="toggleBtn">Start</button>
      <span class="status" id="status">Idle</span>
    </div>

    <div class="row">
      <div class="panel">
        <h3>Original transcript (live)</h3>
        <div id="original" style="opacity: 0.5">
          Transcription will appear here
        </div>
      </div>

      <div class="panel">
        <h3>Translated transcript</h3>
        <div id="translated" style="opacity: 0.5">
          Translation will appear here shortly.
        </div>
      </div>
    </div>

    <div class="panel">
      <h3>Audio Playback</h3>
      <button id="playTTSBtn" disabled>Play Speech</button>
      <audio
        id="ttsAudio"
        controls
        style="width: 100%; margin-top: top 0.5em"
      ></audio>
    </div>

    <script>
      const toggleBtn = document.getElementById("toggleBtn");
      const statusEl = document.getElementById("status");
      const originalEl = document.getElementById("original");
      const translatedEl = document.getElementById("translated");
      const speakerLangSelect = document.getElementById("speakerLangSelect");
      const listenerLangSelect = document.getElementById("listenerLangSelect");
      const playTTSBtn = document.getElementById("playTTSBtn");
      const ttsAudio = document.getElementById("ttsAudio");

      let audioStream = null;
      let mediaRecorder = null;
      let chunkIndex = 0;
      let running = false;
      let fullTranscript = "";

      async function translateTranscript(text, targetLang) {
        const form = new FormData();
        form.append("text", text);
        form.append("language", targetLang);

        const res = await fetch("http://127.0.0.1:8000/translate", {
          method: "POST",
          body: form,
        });

        if (!res.ok) throw new Error(await res.text());
        const j = await res.json();
        return j.translated; // backend will return {translated: "..."}
      }

      async function fetchTTS(text, language) {
        const form = new FormData();
        form.append("text", text);
        // form.append("language", language);

        const res = await fetch("http://127.0.0.1:8000/speak", {
          method: "POST",
          body: form,
        });

        if (!res.ok) throw new Error(await res.text());

        const blob = await res.blob();
        return URL.createObjectURL(blob);
      }

      // Enable TTS button after translation
      async function handleTTS() {
        if (!fullTranscript.trim()) return;

        statusEl.textContent = "Generating speech...";
        playTTSBtn.disabled = true;

        try {
          const ttsUrl = await fetchTTS(
            translatedEl.textContent,
            listenerLangSelect.value
          );
          ttsAudio.src = ttsUrl;
          ttsAudio.play();
          playTTSBtn.disabled = false;
          statusEl.textContent = "Speech ready";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "TTS error";
          playTTSBtn.disabled = false;
        }
      }

      async function startRecording() {
        try {
          audioStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
        } catch (err) {
          alert("Microphone permission required: " + err.message);
          return;
        }

        originalEl.innerHTML = "";
        // translatedEl.textContent = "Translation will appear here in the second half.";
        // translatedEl.style.opacity = "0.5";

        chunkIndex = 0;
        fullTranscript = "";
        running = true;

        recordNextChunk(); // start the first chunk
      }

      function recordNextChunk() {
        if (!running) return;

        mediaRecorder = new MediaRecorder(audioStream, {
          mimeType: "audio/webm;codecs=opus",
        });

        mediaRecorder.addEventListener("dataavailable", async (ev) => {
          if (!ev.data || ev.data.size < 200) return;

          const blob = new Blob([ev.data], { type: "audio/webm;codecs=opus" });
          const file = new File([blob], `chunk-${chunkIndex++}.webm`, {
            type: "audio/webm;codecs=opus",
          });

          const form = new FormData();
          form.append("audio", file);
          const speakerLanguage = speakerLangSelect.value;
          if (speakerLanguage) form.append("language", speakerLanguage);

          // send to API
          statusEl.textContent = "Sending chunk...";
          try {
            const res = await fetch("http://127.0.0.1:8000/transcribe-chunk", {
              method: "POST",
              body: form,
            });
            if (!res.ok) {
              statusEl.textContent = "Server error";
              return;
            }
            const j = await res.json();

            const p = document.createElement("p");
            p.textContent = j.text;
            originalEl.appendChild(p);
            originalEl.scrollTop = originalEl.scrollHeight;
            fullTranscript += j.text + " ";

            statusEl.textContent = `Listening â€” last model: ${j.model}`;
          } catch (err) {
            console.error(err);
            statusEl.textContent = "Network error";
          }
        });

        mediaRecorder.addEventListener("stop", () => {
          // after this chunk, record the next one
          if (running) {
            recordNextChunk();
          }
        });

        mediaRecorder.start();
        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop(); // finalize this chunk
          }
        }, 5000); // 3 seconds per chunk
      }

      async function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === "recording") {
          mediaRecorder.stop();
        }
        if (audioStream) {
          audioStream.getTracks().forEach((t) => t.stop());
        }
        mediaRecorder = null;
        audioStream = null;
        running = false;

        if (fullTranscript.trim()) {
          const listenerLang = listenerLangSelect.value || "English";
          statusEl.textContent = "Translating...";
          translatedEl.textContent = "Translating...";
          translatedEl.style.opacity = "0.5";

          try {
            const translatedText = await translateTranscript(
              fullTranscript,
              // langSelect.value
              listenerLang
            );
            translatedEl.textContent = translatedText;
            translatedEl.style.opacity = "1";
            statusEl.textContent = "Translation done";
            playTTSBtn.disabled = false;
          } catch (err) {
            console.error(err);
            translatedEl.textContent = "Translation failed.";
            statusEl.textContent = "Translation error";
          }
        } else {
          statusEl.textContent = "No transcript to translate";
        }
      }

      toggleBtn.addEventListener("click", () => {
        if (!running) {
          startRecording();
          toggleBtn.textContent = "Stop";
        } else {
          stopRecording();
          toggleBtn.textContent = "Start";
        }
      });

      playTTSBtn.addEventListener("click", handleTTS);
    </script>
  </body>
</html>
